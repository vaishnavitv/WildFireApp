@page "/weather"
@attribute [StreamRendering]
@using WildFireApp.Backend.Model;
@using WildFireApp.Backend;

<PageTitle>Weather</PageTitle>

<h1>Wildfire Data</h1>

<div>
    <EditForm Model="userSelection" OnSubmit="ChangeListings" FormName="UserSelectionForm">
        <div>
            <InputSelect @bind-Value="userSelection!.year">
                @foreach (var year in years)
                {
                    <option value=@year>@year</option>
                }
            </InputSelect>
        </div>
        <div>
            <button type="submit">Submit</button>
        </div>
    </EditForm>
    <label>Change Year</label>
</div>

@if (wildfire == null)
{
    <p><em>Loading Results ...</em></p>
}
else
{
    <table class="table">
        <thead>
            <tr>
                <th>Fire #</th>
                <th>Year</th>
                <th>Status</th>
                <th>Cause</th>
            </tr>
        </thead>
        <tbody>
            @if(wildfire?.features != null)
            foreach (var wildfireResult in wildfire.features)
            {
                <tr>
                    <td>@wildfireResult.properties.FIRE_ID</td>
                    <td>@wildfireResult.properties.FIRE_YEAR</td>
                    <td>@wildfireResult.properties.FIRE_STATUS</td>
                    <td>@wildfireResult.properties.FIRE_CAUSE</td>
                </tr>
            }
        </tbody>
    </table>
}

@code {
    //GeoService.
    private GeoService service = new GeoService();

    //TODO: Write code to use last 5 Years incl. Present Year.
    private List<int> years = [2024, 2023, 2022, 2021, 2020];

    //User Selection.
    class UserSelection
    {
        public int year { get; set; }
    }
    [SupplyParameterFromForm]
    private UserSelection? userSelection { get; set; }

    // Displayed Data.
    private GeoServer.WildFire wildfire;

    protected override async Task OnInitializedAsync()
    {
        userSelection ??= new() { year = -1 };
        await ChangeListings();
    }

    async Task ChangeListings()
    {
        if (userSelection?.year != -1)
        {
            Dictionary<string, Object> userFilter = new Dictionary<string, object>();
            userFilter.Add("FIRE_YEAR", userSelection.year);
            wildfire = await service.GetWildFireResultsByMultipleFilters(userFilter);
        }
        else
        {
            wildfire = await service.GetAllWildFireResults();
        }
    }
}
